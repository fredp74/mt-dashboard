-- Create database
CREATE DATABASE trading_dashboard;
USE trading_dashboard;

-- Create user with limited privileges
CREATE USER 'trading_user'@'localhost' IDENTIFIED BY 'your_secure_password_123!';
GRANT SELECT, INSERT, UPDATE ON trading_dashboard.* TO 'trading_user'@'localhost';
FLUSH PRIVILEGES;

-- Create the main table
CREATE TABLE trading_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_type ENUM('MT5') NOT NULL,
    balance DECIMAL(15,2) NOT NULL,
    equity DECIMAL(15,2) NOT NULL,
    profit DECIMAL(15,2) NOT NULL,
    margin DECIMAL(15,2) DEFAULT 0,
    free_margin DECIMAL(15,2) DEFAULT 0,
    open_positions INT DEFAULT 0,
    total_volume DECIMAL(10,2) DEFAULT 0,
    drawdown DECIMAL(15,2) DEFAULT 0,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_timestamp (timestamp),
    INDEX idx_account_type (account_type),
    INDEX idx_composite (account_type, timestamp)
) ENGINE=InnoDB;

-- Create cleanup procedure for old data (optional)
DELIMITER //
CREATE PROCEDURE CleanupOldData()
BEGIN
    DELETE FROM trading_history 
    WHERE timestamp < DATE_SUB(NOW(), INTERVAL 90 DAY);
END //
DELIMITER ;

-- Create event to run cleanup weekly
CREATE EVENT weekly_cleanup
ON SCHEDULE EVERY 1 WEEK
DO CALL CleanupOldData();